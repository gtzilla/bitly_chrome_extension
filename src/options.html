<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" manifest="cache-manifest">

<!-- MIME TYPE Guidlines and references: http://hixie.ch/advocacy/xhtml -->
    <head>
        <title>bit.ly Extension Settings</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="keywords" content="bit.ly" />
        <link rel="stylesheet" href="css/basic.css" type="text/css" charset="utf-8" />
        <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />
        <link rel="stylesheet" href="css/options.css" type="text/css" charset="utf-8" />
    </head>
    <body>
        <div id="container">
             
             <div id="top">
                    
                    <div id="blueBanner">
                        <ul class="ext_nav_list">
                            <!-- <li><a class="openOptions" href="">Options</a></li> -->
                        </ul>
                    
                    </div>
                    
                    <div id="logo">
                        <a href="options.html"><img src="s/graphics/bitly_logo.png" alt="" border="0"width="280px" height="47px"  /></a>
                    </div>
                    <!-- <div id="ext_top_nav">
                        <div id="ext_top_nav_inner">
                        
                        </div>
                        <div class="hr"><hr /></div>
                    </div> -->
                
                </div> <!-- end #top -->
            
            <div id="middle">
                
                <h1 id="bitly_options">Settings</h1>
                
                <div id="signedin_info_contents" style="display:none;">
                    
                    <div id="signOutButtonContainer">
                        <a class="signout" href="#">Sign Out</a>
                    </div>
                    
                    <div id="share_accounts"></div>
                    

                    
                    <div class="options_container">
                        <h3>Auto Copy Short Urls</h3>
                        <p>Automatically copy short urls to my clipboard when popup opens</p>
                        <div>
                            <input type="checkbox" name="auto_copy_short_urls" value="" id="auto_copy_short_urls">
                            <label for="auto_copy_short_urls">Auto Copy Short Urls</label>
                        
                        </div>
                    </div>
                    
                    <div class="options_container">
                        <h3>Twitter Enhance</h3>
                        <p>Display a shorten button on twitter.com when I enter a long URL</p>
                        <div>
                            <input type="checkbox" name="enhance_twitter" value="" id="enhance_twitter">
                            <label for="enhance_twitter">Enhance Twitter</label>
                        
                        </div>
                    </div>                    
                    
                    <div class="options_container">
                        <h3>Trend Notifications</h3>
                        <p>Automatically notify me when my link starts to become popular, or trend. Notifications will be shown when a link reaches the threshold specified below during the past hour.</p>
                        <div>

                            <input type="checkbox" name="watch_urls" value="" id="watch_urls">

                            <label for="watch_urls">Enable Notifications</label>
                            
                            <div class="smallInputContainer notificationInnerContainer" style="display:none;">
                            <form id="notifications_form" action="#" method="get" accept-charset="utf-8">
                                
                                <label for="click_threshold">Default Click Threshold</label>
                                <input type="text" name="click_threshold" value="20" id="click_threshold">
                                <input type="submit" class="activeButtons mediumSizeButton" id="submitClickThreshold" value="Update" id="some_name">

                            </form>

                                
                                <p class="no_domains_note">Note: Threshold can be any integer from 5-5,000</p>
                            </div>
                            <div id="watching_links_box">
                                
                            </div>                            

                        
                        </div>
                    </div>                    
                    
                    
                    <div id="auto_expand_container" style="display:none;" class="options_container">
                        <h3>Auto Expand Links</h3>
                        <p>Shows a link preview, for bit.ly, on pages you visit. This change only applies to new page loads.</p>
                        <div>
                            <input type="checkbox" checked name="show_link_preview" value="" id="show_link_preview">
                            <label for="show_link_preview">Show Link Preview</label>
                        </div>
                        <div id="no_expand_domains_box"></div>
                    
                    </div>
                    

                    <div id="api_domains">
                        
                        <div class="api_type_selector options_container">
                        <h3>API Domains</h3>
                            
                            <p>You can choose either the bit.ly API or the j.mp API. Both work just the same way, but j.mp is just a little shorter. This change only applies to new shortens.</p>
                            
                            <form id="api_choice_form" action="#" method="get" accept-charset="utf-8">
                                
                                <div class="bentoOptions">
                                    
                                    <input type="radio" name="api_choice" checked value="bit.ly" id="jmp">
                                    <label for="jmp">Use bit.ly API</label>
                                </div>
                                
                                <div class="bentoOptions">
                                    <input type="radio" name="api_choice" value="j.mp" id="bitly">
                                    <label for="bitly">Use j.mp API</label>
                                
                                </div>

                            
                            </form>
                        </div>
                    </div>                    

                    
                
                </div>
                <div id="signedout_info_contents" style="display:none;">
                    <form id="signin_form" action="#" method="get" accept-charset="utf-8">
                        
                        <div id="errors_box" class="chrome_page_errors_box" style="display:none;"></div>
                        
                        <div class="inputContainer">
                            <label for="username">Username</label>
                            <input type="text" name="username" value="" id="username">
                        </div>


                        
                        <div class="inputContainer">
                            <label for="password">Password</label>
                            <input type="password" name="password" value="" id="password">
                        </div>
                        
                        <div id="signInContainer">
                            <div id="signInButtonContainer">
                                <input type="submit" class="activeButtons mediumSizeButton" name="some_name" value="Sign In" id="some_name">
                            </div>
                            <div style="display:none;" id="sign_in_loader">
                                <img src="s/graphics/loader_signin_30_30.gif" height="30" width="30" border="0" alt="" />
                            </div>
                        </div>
                        
                        
                        <div class="meta_graph">
                            <p>Not a bit.ly or j.mp user? <a href="http://bit.ly/a/sign_up">Get an account</a></p>
                        </div>
                    
                    </form>
                </div>
                
                <div id="logging_box" style="display:none;">
                    <a id="logs_show_link" href="#">Logs</a>
                </div>
            
            </div> <!-- END #middle -->
            
            <div id="bottom">
            
            </div> <!-- end #bottom -->
        
        </div> <!-- end #container -->
        
            
            <!-- <script type="text/javascript" src=""></script> -->
            <script type="text/javascript" src="js/libs/common.js"></script>
            <script type="text/javascript" src="js/libs/fastFrag.js"></script>            
            <script type="text/javascript" src="js/libs/logFormat.js"></script>
            <script type="text/javascript" src="js/libs/timeFormat.js"></script>            
            <script type="text/javascript" charset="utf-8">
                
                var bg = chrome.extension.getBackgroundPage(),
                    note_prefs = bg.get_note_preferences(),
                    user_data = bg.localfetch("user_data"),
                    auto_copy_elem = _id("auto_copy_short_urls"),
                    enhance_twitter_input = _id("enhance_twitter"),
                    errors_box_elem = _id("errors_box"),
                    signInButtonContainer_elem = _id("signInButtonContainer"),
                    sign_in_loader_elem = _id("sign_in_loader"),
                    logging_box_elem = _id("logging_box"),
                    elem, header = _id("bitly_options"),
                    shares_elem = _id("share_accounts"),
                    api_form_elem = _id("api_choice_form"),
                    api_domains_elem = _id("api_domains"),
                    no_expand_domains_box_elem = _id("no_expand_domains_box"),
                    url_expand_input = _id("show_link_preview"),
                    bod = document.body,
                    active_account_list = [],
                    login_attempt_count=0;

                
                function get_safe_threshold( num_value ) {
                     
                    var safe_value = Math.max(num_value, 5);
                    safe_value = Math.ceil( Math.min(safe_value, 5000) );
                    
                    return safe_value;
                }
                
                
                function set_api_radio_button() {
                    var api_domain = bg.get_api_domain(),
                        radios = api_form_elem.getElementsByTagName("input"),
                        i=0, radio;
                    
                    for(; radio=radios[i]; i++) {
                        if( radio.type !== "radio" ) continue;
                        
                        if(radio.value.trim() === api_domain ) {
                            radio.checked=true;
                        } else {
                            radio.checked=false;
                        }
                    }
                }
                
                function display_add_domain_no_expand_input( parent_elem ) {
                    var results, structure = {
                        css : "domains_host_container",
                        content : [{
                            type : "input",
                            id : "no_expand_domain_new_domain",
                            attributes : {
                                name : "no_expand_domain_new_domain",
                                type : "text"
                            }
                        },{
                            type : "input",
                            css : "activeButtons",
                            id : "add_new_no_expand_domain",
                            attributes : {
                                name : "add_new_no_expand_domain",
                                type : "submit",
                                value : "Add"
                            }                            
                        }]
                    }
                    
                    results = fastFrag.create( structure );
                    parent_elem.appendChild( results );
                }
                
                function display_no_expand_domains() {
                    var d_list = bg.get_no_expand_domains(), i=0,
                        domain, disble_box="disabled", structured_items = [];
                    for( ; domain=d_list[i]; i++) {
                        // note
                        // if bit.ly / j.mp ever support hover card, change to checked, to encourage removal
                        if(domain === "bit.ly" || domain === 'j.mp') { disble_box = true; }
                        else { disble_box = false; }
                        
                        structured_items.push({
                            type : "li",
                            content : [{
                                type : "input",
                                id : 'no_expand_d_'+i,
                                css : "no_expand_check",
                                attributes: {
                                    type : "checkbox",
                                    value : domain,
                                    name : "no_expand_domain",
                                    disabled : disble_box
                                }
                            },{
                                type : "label",
                                content : domain,
                                attributes : {
                                    'for' : 'no_expand_d_'+i
                                }
                            },{
                                css : "hr",
                                content : {
                                    type : "hr"
                                }
                            }]
                        });
                        
                    }

                    
                    var structure = [{
                        type : "h4",
                        content : 'Except These Domains:'
                    },{
                        type : "ul",
                        css : "no_expand_domains_list",
                        content : structured_items
                    },{
                        id : "new_no_expand_domain"
                    },{
                        content : [{
                            type : "a",
                            id : "add_no_expand_domain_form",
                            content : "Add domain host",
                            attributes : {
                                href : "#"
                            }
                        },{
                            text : " | "
                        },{
                            type : "a",
                            content : "Remove selected",
                            id : "remove_no_expand_domains",
                            attributes : {
                                href : "#"
                            }
                        },{
                            type : "p",
                            css : "no_domains_note",
                            content : "Note: subdomains must be specified, facebook.com will not match www.facebook.com"
                        }]
                    }]
                    //div.innerHTML = html;
                    no_expand_domains_box_elem.innerHTML = "";
                    no_expand_domains_box_elem.appendChild( fastFrag.create( structure ) )
                
                }
                
                
                
                function display_logs() {
                    
                    var strucuture_items = [], logs = bg.get_logs(), html = "", i=0,
                        log, div, time,
                        ul = logging_box_elem.getElementsByTagName("ul"),
                        display_time, hour, am_or_pm;
                    
                    if(ul.length>0)  {
                        console.log(ul)
                        logging_box_elem.removeChild( _id("logs_list_box") )
                        return;
                    } else {
                        div = document.createElement("div");
                        div.id="logs_list_box"
                    }
                    //html += '<ul class="log_item_list">'
                    for( ; log=logs[i]; i++) {
                        time = new Date( log.timestamp );
                        strucuture_items.push({
                            type : "li",
                            content : [{
                                type : "span",
                                css : "log_date",
                                content : time.logFormat()
                            },{
                                css : "log_message",
                                type : "span",
                                content : log.message
                            },{
                                css : "hr",
                                content : {
                                    type : "hr"
                                }
                            }]
                        });
                    }
                    //html += '</ul>';
                    
                    var structure = {
                        type : "ul",
                        css : "log_item_list",
                        content : strucuture_items
                    }
                    //div.innerHTML = "";
                    console.log("insert logs")
                    logging_box_elem.innerHTML = "";
                    logging_box_elem.appendChild( fastFrag.create( structure ) );
                
                }
                
                function list_accounts_callback(response) {
                    //console.log(response, "accounts list")
                    if(response.error) {
                        document.location.reload();
                    }
                    var accounts = response && response.share_accounts, i=0,
                        account, html = "", status, structure, structure_items=[];
                    
                    for(; account=accounts[i]; i++) {
                        status = (account.active) ? "on" : "off";                    
                        structure_items.push({
                            type : "li",
                            id : account.account_id,
                            attributes : {
                                'status' : status
                            },
                            content : [{
                                type : "img",
                                css : "account_icon",
                                attributes : {
                                    src : 's/graphics/'+ account.account_type +'-'+ status +'.png',
                                    border : 0,
                                    alt : ""
                                }
                            },{
                                type : "span",
                                css : "account_name",
                                content : ( account.account_name || account.account_login )
                            },{
                                type : "a",
                                css : "sharingControl",
                                content : 'Sharing ' + status,
                                attributes : {
                                    href : "#"
                                }
                            }]
                        })
                    }
                    
                    
                    structure = [{
                        type : "h3",
                        content : "Services"
                    },{
                        type : "p",
                        content : "Share your links on:"
                    }, {
                        type : "ul",
                        content : structure_items
                    },{
                        css : "meta_graph",
                        content : {
                            type : "p",
                            content : [{
                                type : "a",
                                css : "add_or_remove",
                                content : "Add or remove",
                                attributes : {
                                    href : "http://bit.ly/a/account",
                                    target : "new"
                                }                                
                            },{
                                text : " accounts on bit.ly | "
                            },{
                                type : "a",
                                css : "resync",
                                content : "Refresh account list",
                                attributes : {
                                    href : "#"
                                } 
                            }]
                        }
                    }]
                    
                    shares_elem.innerHTML = "";
                    shares_elem.appendChild( fastFrag.create( structure )  );
                }
                
                // events
                
                function signin_form_event( e ){
                    e.preventDefault();
                    login_attempt_count+=1;
                    // validate form
                    var username = _id("username"),
                        pass = _id("password"),
                        error_message_text = "Sorry, your username and password don't match";
                    if(username.value === "" ||  pass.value === "") {
                        console.log("all fields required")
                        errors_box_elem.innerHTML = "All fields required"
                        errors_box_elem.style.display="block";
                        return;
                    }

                    sign_in_loader_elem.style.display="block";
                    signInButtonContainer_elem.style.display="none";
                    errors_box_elem.style.display="none";
                    bg.sign_in( username.value, pass.value, function(jo) {                        
                        //console.log(jo)
                        if(jo && !jo.error) {
                            document.location.reload();
                            return;
                        } else if(jo && jo.status_code === 401) {
                            // set diff default text here
                        } else {
                            error_message_text = "An error occurred trying to sign in"
                        }
                        
                        if(login_attempt_count > 5) {
                            alert("It looks like you found some type of bug, please email us at support@bit.ly with your username.");
                            document.location.reload();                            
                        } else if(login_attempt_count > 3) {
                            alert("Please contact us at support@bit.ly, there appears to be a problem");
                        }
                        
                        
                        sign_in_loader_elem.style.display="none";
                        signInButtonContainer_elem.style.display="block";
                        errors_box_elem.innerHTML = error_message_text;
                        errors_box_elem.style.display="block";
                        console.log("Failed sign in")
                        bg.logger("Failed sign in attempt: " + JSON.stringify( jo ) );
                    
                    });
                
                }
                
                /*
                     Determine which 'display' to show user. Signed In || Sign In
                */
                
                if(user_data && user_data.x_login) {
                    elem = _id("signedin_info_contents");
                    elem.style.display="block";
                    // _id("api_key").setAttribute("value", user_data.x_apiKey);
                    // _id("current_username").innerText = user_data.x_login;
                    var domain_elem = _id("api_domains")
                    header.innerText = user_data.x_login + " Settings";
                    chrome.extension.sendRequest( {'action' : 'share_accounts' }, list_accounts_callback );
                    api_domains_elem.style.display="block";
                    _id("auto_expand_container").style.display="block";
                    
                    if( bg.get_url_expansion() ) {
                        url_expand_input.checked=true;
                        // show domains
                        display_no_expand_domains();
                    } else {
                        url_expand_input.checked=false;
                    }
                    
                    if(bg.get_enhance_twitter()) {
                        enhance_twitter_input.checked=true;
                    } else {
                        enhance_twitter_input.checked=false;
                    }
                    
                    if( bg.get_auto_copy() ) {
                        auto_copy_elem.checked=true;
                    } else {
                        auto_copy_elem.checked=false;
                    }
                    set_api_radio_button();
                    
                    if( note_prefs ) {
                        console.log(note_prefs, "hrm")
                        watch_urls.checked=note_prefs.enabled;
                        var show_watch_check = (note_prefs.enabled) ? "block" : "none";
                        
                        //display_user_watched_links.style.display=show_watch_check;
                        // if(note_prefs.enabled){
                        //     display_user_watched_links();
                        // }
                            
                        _q('.notificationInnerContainer').style.display=show_watch_check;
                        _q('[type=text]', notifications_form).value = note_prefs.threshold || 20;                        
                    } 

                    
                    
                } else {
                    elem = _id("signedout_info_contents");
                    elem.style.display="block";
                    header.innerText = "Sign in via bit.ly";
                }
                
                _id("logs_show_link").addEventListener("click", function(e) {
                    e.preventDefault();
                    display_logs();
                
                })
                
                _id("signin_form").addEventListener('submit', signin_form_event)
                
                shares_elem.addEventListener('click', function(e) {
                    var params={ 'action' : 'activate_account' }, img, status, parent;
                    if(e.target.nodeName.toLowerCase() === "img" || e.target.className === "sharingControl") {
                        parent = e.target.parentNode;
                        status = ( parent.getAttribute("status").indexOf("on") < 0 );
                        //console.log(status)
                        params.account_id = parent.id
                        params.active = status;
                        chrome.extension.sendRequest( params, list_accounts_callback );
                    }
                    
                    if(e.target.className === "resync") {
                        e.preventDefault();
                        chrome.extension.sendRequest( {'action' : 're_sync_share_accounts' }, list_accounts_callback )
                    }
                
                });
                
                url_expand_input.addEventListener('change', function(e) {
                    //console.log("change", e, e.target.checked)
                    
                    if(e.target.checked) {
                        display_no_expand_domains();
                    } else {
                        url_expand_input.checked=false;
                        no_expand_domains_box_elem.innerHTML = "";
                    }
                    bg.set_url_expansion( e.target.checked );
                });
                auto_copy_elem.addEventListener("change", function(e) {
                    bg.set_auto_copy(e.target.checked);
                });
                
                enhance_twitter_input.addEventListener('change', function(e) {
                    if(e.target.checked) {
                        
                    } else {
                        enhance_twitter_input.checked=false;
                    }
                    
                    bg.set_enhance_twitter_com( e.target.checked );
                });
                
                no_expand_domains_box_elem.addEventListener('click', function(e) {
                    var t = e.target, inputs, input, i=0, removed_count = 0, p;
                    if(t===this) return;
                    
                    switch(t.id) {
                        case "add_no_expand_domain_form":
                            e.preventDefault();
                            // add form input
                            display_add_domain_no_expand_input( _id("new_no_expand_domain") )
                        break;
                        
                        case "remove_no_expand_domains":
                            e.preventDefault();
                            inputs = no_expand_domains_box_elem.getElementsByTagName("input");
                            for( ; input=inputs[i]; i++) {
                                console.log( input.checked, input.value );
                                if(input.checked && input.type === "checkbox") {
                                    removed_count+=1;
                                    bg.remove_no_expand_domain( input.value );
                                }
                            }
                        
                            
                            if(removed_count > 0) {
                                display_no_expand_domains();
                            }
                        break;
                        
                        case "add_new_no_expand_domain":
                            console.log(t, e)
                            p=t.parentNode;
                            console.log(p)
                            input = p.getElementsByTagName("input")[0];
                            if( input.value.trim() !== "") {
                                var domain_host = input.value;
                                bg.add_no_expand_domain( domain_host );
                                //p.parentNode.removeChild(p);
                                display_no_expand_domains();
                            }
                        break;
                    
                    }
                
                });
                
                
                notifications_form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    var thres = _q("[type=text]", this), safe_value;
                    console.log(thres.value);
                    safe_value = get_safe_threshold( thres.value );
                    // todo
                    // error handle, more than 0 clicks
                    bg.set_note_preferences( { 'enabled': true, 'threshold' : safe_value } );                    

                })
                
                watch_urls.addEventListener('change', function(e) {
                    bg.set_note_preferences( { 'enabled': e.target.checked } );
                    var shown = "none"
                    if(e.target.checked) {
                        shown="block";
                    }
                    _q('.notificationInnerContainer').style.display=shown;                    
                });
                
                api_form_elem.addEventListener('change', function(e) {
                    //e.target,
                    if(e.target.type !== "radio") { return; }
                    //console.log(e, "api form changed", e.target.nodeName, e.target.type, e.target.value)
                    bg.set_api_domain( e.target.value  )
                })
                
                bod.addEventListener('click', function(e) {
                    
                    if(e.target.className === "signout") {
                        e.preventDefault();
                        bg.sign_out();
                        document.location.reload();
                    }
                
                });
                
                setTimeout(function() {
                    addClass(bod, "page_loaded");
                }, 20);

            
            </script>
    
    </body>
</html>
